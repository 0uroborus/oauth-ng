/**
 * ng-oauth
 * @version v0.1.0 - 2013-10-28
 * @link https://github.com/lelylan/oauth-ng
 * @author Andrea Reginato
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

"use strict";angular.module("oauth",["oauth.directive","oauth.accessToken","oauth.endpoint","oauth.requestWrapper","oauth.profile","oauth.config"]),angular.module("oauth").config(["$locationProvider",function(a){a.html5Mode(!0).hashPrefix("!")}]);var directives=angular.module("oauth.directive",[]);directives.directive("oauth",["AccessToken","Endpoint","Profile","oauth.config","$location","$rootScope","$compile","$http","$templateCache",function(a,b,c,d,e,f,g,h,i){var j={restrict:"AE",replace:!1,scope:{site:"@",client:"@",redirect:"@",scope:"@",flow:"@",view:"@",storage:"@",profile:"@",template:"@"}};return j.link=function(e,j){e.show="none",e.$watch("client",function(){k(),l(),b.set(e),a.set(e),m(),n()});var k=function(){e.authorizePath=e.authorizePath||"/oauth/authorize",e.tokenPath=e.tokenPath||"/oauth/token",e.flow=e.flow||"implicit",e.view=e.view||"standard",e.storage=e.storage||"none",e.template=e.template||"views/templates/default.html"},l=function(){h.get(e.template,{cache:i}).success(function(a){j.html(a),g(j.contents())(e)})},m=function(){var b=a.get();b&&b.access_token&&d.profile&&(e.profile=c.get())},n=function(b){var b=a.get();return b?b.access_token?o():b.error?q():void 0:p()};e.login=function(){b.redirect()},e.logout=function(){a.destroy(e),p()};var o=function(){f.$broadcast("oauth:success",a.get()),e.show="logout"},p=function(){f.$broadcast("oauth:logout"),e.show="login"},q=function(){e.show="denied",f.$broadcast("oauth:denied")};e.$on("oauth:template",function(a,b){e.template=b,l(e)})},j}]);var service=angular.module("oauth.accessToken",["ngCookies"]);service.factory("AccessToken",["$location","$http","$cookies","$rootScope",function(a,b,c){var d={},e=null;d.get=function(){return e},d.set=function(a){return f(a),h(a),e},d.destroy=function(a){return e=null,delete c[a.client],e},d.expired=function(){return e&&e.expires_at&&e.expires_at<new Date};var f=function(b){var c=g(a.hash());c&&(l(),j(c,b))},g=function(a){for(var b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("="),f=e[0],g=e[1];c[f]=g}return c.access_token||c.error?c:void 0},h=function(a){if("cookies"==a.storage&&c[a.client]){var b=JSON.parse(c[a.client]);j(b,a)}},i=function(a,b){"cookies"==a.storage&&b&&b.access_token&&(c[a.client]=JSON.stringify(b))},j=function(a,b){return e=e||{},angular.extend(e,a),k(),i(b,a),e},k=function(){if(e){var a=new Date;a.setSeconds(a.getSeconds()+parseInt(e.expires_in)-60),e.expires_at=a}},l=function(){a.hash("")};return d}]);var client=angular.module("oauth.endpoint",[]);client.factory("Endpoint",["AccessToken","$location",function(a,b){var c,d={};return d.set=function(a){return c=a.site+a.authorizePath+"?response_type=token&client_id="+a.client+"&redirect_uri="+a.redirect+"&scope="+a.scope+"&state="+b.url()},d.get=function(){return c},d.redirect=function(){window.location.replace(c)},d}]);var client=angular.module("oauth.requestWrapper",["ngResource"]);client.factory("RequestWrapper",["AccessToken","Endpoint","$http",function(a,b,c){var d={};d.wrap=function(a,b){for(var c=a,d=0;d<b.length;d++)e(c,b[d]);return c};var e=function(c,d){c["_"+d]=c[d],c[d]=function(e,g,h,i){var j=a.get();return j&&a.expired()&&b.redirect(),f(j),c["_"+d].call(this,e,g,h,i)}},f=function(a){a?c.defaults.headers.common.Authorization="Bearer "+a.access_token:delete c.defaults.headers.common.Authorization};return d}]);var client=angular.module("oauth.profile",["ngResource"]);client.factory("Profile",["RequestWrapper","$resource","oauth.config",function(a,b,c){var d=b(c.profile,{},{});return a.wrap(d,["get"])}]),angular.module("oauth.config",[]).value("oauth.config",{profile:null});